-- 建立資料表
CREATE TABLE invoice_books (
    id INT AUTO_INCREMENT PRIMARY KEY,
    track VARCHAR(2) NOT NULL,              -- 發票字軌（AA、AB、AC）
    begin_number INT NOT NULL,              -- 發票起始號碼
    end_number INT NOT NULL,                -- 發票結束號碼
    year INT NOT NULL,                      -- 發票年份（民國113年 > 2024）
    month INT NOT NULL,                     -- 發票月份（03）
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,  
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE(track, begin_number, end_number)  -- 確保發票區間不重複
);

CREATE TABLE invoices (
    id INT AUTO_INCREMENT PRIMARY KEY,
    invoice_number VARCHAR(13) NOT NULL UNIQUE,  -- 發票號碼（例如：AA-12345678）
    invoice_date DATE NOT NULL,                  -- 開立日期
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,  
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 新增模擬資料

INSERT INTO invoice_books (track, begin_number, end_number, year, month)
VALUES 
('AA', 12345600, 12345649, 113, 03),
('AB', 98765400, 98765449, 113, 03),
('AC', 45678900, 45678999, 113, 03);

INSERT INTO invoices (invoice_number, invoice_date)
VALUES 
('AA-12345600', '2024-03-01'),
('AA-12345601', '2024-03-01'),
('AA-12345602', '2024-03-01'),
('AA-12345603', '2024-03-01'),
('AA-12345604', '2024-03-02'), -- 跳過5-8
('AA-12345609', '2024-03-02'),
('AA-12345610', '2024-03-02'),
('AA-12345611', '2024-03-02'),
('AA-12345612', '2024-03-02'),
('AA-12345613', '2024-03-02'),
('AA-12345614', '2024-03-02'),
('AA-12345615', '2024-03-02'),
('AA-12345616', '2024-03-03'),
('AA-12345617', '2024-03-03'),
('AA-12345618', '2024-03-03'),
('AA-12345619', '2024-03-03'),
('AA-12345620', '2024-03-03'),
('AA-12345621', '2024-03-04'),
('AA-12345622', '2024-03-05'),
('AA-12345623', '2024-03-05'),
('AA-12345624', '2024-03-05'),
('AA-12345625', '2024-03-05'),
('AA-12345626', '2024-03-05'),
('AA-12345627', '2024-03-05'),
('AA-12345628', '2024-03-05'),
('AA-12345629', '2024-03-05'),
('AA-12345630', '2024-03-05'),
('AA-12345631', '2024-03-05'),
('AA-12345632', '2024-03-06'),
('AA-12345633', '2024-03-06'),
('AA-12345634', '2024-03-06'),
('AA-12345635', '2024-03-06'),
('AA-12345636', '2024-03-06'),
('AA-12345637', '2024-03-06'),
('AA-12345638', '2024-03-07'),
('AA-12345639', '2024-03-07'),
('AA-12345640', '2024-03-07'),
('AA-12345641', '2024-03-07'),
('AA-12345642', '2024-03-07'),
('AA-12345643', '2024-03-07'),
('AA-12345644', '2024-03-07'),
('AA-12345645', '2024-03-08'),
('AA-12345646', '2024-03-08'),
('AA-12345647', '2024-03-08'),
('AA-12345648', '2024-03-08'),
('AA-12345649', '2024-03-08'),
('AB-98765400', '2024-03-09'),
('AB-98765401', '2024-03-09'),
('AB-98765402', '2024-03-09'),
('AB-98765403', '2024-03-09'),
('AB-98765404', '2024-03-09'),
('AB-98765405', '2024-03-09'),
('AB-98765406', '2024-03-09'),
('AB-98765407', '2024-03-09'), --  跳過 8-13
('AB-98765414', '2024-03-10'),
('AB-98765415', '2024-03-10'),
('AB-98765416', '2024-03-10'),
('AB-98765417', '2024-03-10'),
('AB-98765418', '2024-03-11'),
('AB-98765419', '2024-03-11'),
('AB-98765420', '2024-03-11'),
('AB-98765421', '2024-03-11'),
('AB-98765422', '2024-03-11'),
('AB-98765423', '2024-03-12'),
('AB-98765424', '2024-03-12'),
('AB-98765425', '2024-03-12'),
('AB-98765426', '2024-03-12'),
('AB-98765427', '2024-03-12'),
('AB-98765428', '2024-03-12'),
('AB-98765429', '2024-03-12'),
('AB-98765430', '2024-03-13'),
('AB-98765431', '2024-03-13'),
('AB-98765432', '2024-03-13'),
('AB-98765433', '2024-03-13'),
('AB-98765434', '2024-03-13'),
('AB-98765435', '2024-03-13'),
('AB-98765436', '2024-03-14'),
('AB-98765437', '2024-03-14'),
('AB-98765438', '2024-03-14'),
('AB-98765439', '2024-03-14'),
('AB-98765440', '2024-03-15'),
('AB-98765441', '2024-03-15'),
('AB-98765442', '2024-03-15'),
('AB-98765443', '2024-03-15'),
('AB-98765444', '2024-03-15'),
('AB-98765445', '2024-03-15'),
('AB-98765446', '2024-03-15'),
('AB-98765447', '2024-03-15'),
('AB-98765448', '2024-03-16'),
('AB-98765449', '2024-03-16'),
('AC-45678900', '2024-03-16'),
('AC-45678901', '2024-03-16'),
('AC-45678902', '2024-03-16'),
('AC-45678903', '2024-03-17'),
('AC-45678904', '2024-03-17'),
('AC-45678905', '2024-03-17'),
('AC-45678906', '2024-03-17'),
('AC-45678907', '2024-03-17'),
('AC-45678908', '2024-03-17'),
('AC-45678909', '2024-03-18'),
('AC-45678910', '2024-03-18'),
('AC-45678911', '2024-03-18'),
('AC-45678912', '2024-03-18'),
('AC-45678913', '2024-03-18'),
('AC-45678914', '2024-03-18'),
('AC-45678915', '2024-03-18'),
('AC-45678916', '2024-03-18'),
('AC-45678917', '2024-03-19'),
('AC-45678918', '2024-03-19'),
('AC-45678919', '2024-03-19'),
('AC-45678920', '2024-03-19'),
('AC-45678921', '2024-03-19'),
('AC-45678922', '2024-03-20'),
('AC-45678923', '2024-03-20'),
('AC-45678924', '2024-03-20'),
('AC-45678925', '2024-03-20'),
('AC-45678926', '2024-03-20'),
('AC-45678927', '2024-03-21'),
('AC-45678928', '2024-03-21'),
('AC-45678929', '2024-03-21'),
('AC-45678930', '2024-03-21'),
('AC-45678931', '2024-03-21'),
('AC-45678932', '2024-03-21'),
('AC-45678933', '2024-03-21'),
('AC-45678934', '2024-03-21'),
('AC-45678935', '2024-03-21'),
('AC-45678936', '2024-03-21'),
('AC-45678937', '2024-03-22'),
('AC-45678938', '2024-03-22'),
('AC-45678939', '2024-03-23'),
('AC-45678940', '2024-03-23'),
('AC-45678941', '2024-03-23'),
('AC-45678942', '2024-03-23'),
('AC-45678943', '2024-03-23'),
('AC-45678944', '2024-03-23'),
('AC-45678945', '2024-03-24'),
('AC-45678946', '2024-03-24'),
('AC-45678947', '2024-03-24'),
('AC-45678948', '2024-03-24'),
('AC-45678949', '2024-03-24'),
('AC-45678950', '2024-03-24'),
('AC-45678951', '2024-03-25'),
('AC-45678952', '2024-03-25'),
('AC-45678953', '2024-03-25'),
('AC-45678954', '2024-03-25'),
('AC-45678955', '2024-03-25'),
('AC-45678956', '2024-03-26'),
('AC-45678957', '2024-03-26'),
('AC-45678958', '2024-03-26'),
('AC-45678959', '2024-03-26'),
('AC-45678960', '2024-03-26'),
('AC-45678961', '2024-03-26'),
('AC-45678962', '2024-03-27'),
('AC-45678963', '2024-03-27'),
('AC-45678964', '2024-03-27'),
('AC-45678965', '2024-03-27'),
('AC-45678966', '2024-03-27'), --  跳過67-77
('AC-45678978', '2024-03-30'),
('AC-45678979', '2024-03-30'),
('AC-45678980', '2024-03-30'),
('AC-45678981', '2024-03-31'),
('AC-45678982', '2024-03-31'),
('AC-45678983', '2024-03-31'),
('AC-45678984', '2024-03-31'),
('AC-45678985', '2024-03-31'),
('AC-45678986', '2024-03-31'),
('AC-45678987', '2024-03-31'),
('AC-45678988', '2024-03-31');

-- main query
WITH RECURSIVE invoice_series AS (
    SELECT id, track, begin_number AS num, end_number, year, month FROM invoice_books
    UNION ALL
    SELECT id, track, num + 1, end_number, year, month FROM invoice_series WHERE num < end_number
)

SELECT 
    isr.id AS id, 
    CONCAT(isr.track, '-', LPAD(isr.num, 8, '0')) AS invoice_number,
    isr.track, 
    isr.year, 
    isr.month, 
    (SELECT begin_number FROM invoice_books WHERE track = isr.track LIMIT 1) AS begin_number, 
    (SELECT end_number FROM invoice_books WHERE track = isr.track LIMIT 1) AS end_number
FROM invoice_series isr
LEFT JOIN invoices inv ON CONCAT(isr.track, '-', LPAD(isr.num, 8, '0')) = inv.invoice_number
WHERE inv.invoice_number IS NULL AND NOT (isr.track = 'AC' AND isr.num >= 45678988)
ORDER BY isr.track, isr.num;
